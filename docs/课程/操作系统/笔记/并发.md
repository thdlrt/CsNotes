### ç®€åŒ–çš„çº¿ç¨‹æ¨¡å‹ (è¯¾ç¨‹ä¸­ç”¨äºæ¼”ç¤º)
- heap è¡¨ç¤ºå…±äº«å†…å­˜
- ä¸¤ä¸ªçº¿ç¨‹æ“ä½œ APIï¼ˆ[[docs/è¯¾ç¨‹/æ“ä½œç³»ç»Ÿ/ä»£ç /thread-lib/thread.h|thread.h]]ï¼‰
	- `create(fn)`ï¼šåˆ›å»ºä¸€ä¸ªå…¥å£æ˜¯ ` fn ` çš„å…¥å£å‡½æ•°å¹¶ç«‹å³æ‰§è¡Œ
	- `join()` ç­‰å¾…æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„è¿”å›
### å¹¶å‘ç¼–ç¨‹ä¸­è¦"æ”¾å¼ƒ"çš„ä¹ æƒ¯å‡è®¾
- **çŠ¶æ€è¿ç§»åŸå­æ€§**ï¼š
	- å…±äº«å†…å­˜æ¨ç¿»äº†"åŸå­æ€§"å‡è®¾
	- æ¯”å¦‚ `i++` å°±ä¸å†å…·æœ‰åŸå­æ€§

- ç¨‹åº**é¡ºåºæ‰§è¡Œ**å‡è®¾ï¼š
```python
def T_sum():
    for _ in range(3):
        t = heap.sum
        sys_sched()
        t = t + 1
        heap.sum = t
        sys_sched()
    sys_write(f'sum = {heap.sum}\n')

def main():
    heap.sum = 0
    sys_spawn(T_sum)
    sys_spawn(T_sum)
    sys_spawn(T_sum)

```
- sum çš„æœ€å°è¾“å‡ºç»“æœä¸º 2ï¼ˆæ— è®ºå¤šå°‘ä¸ªçº¿ç¨‹éƒ½æ˜¯ 2ï¼‰
	- è¦æƒ³ä¸º 2ï¼Œåˆ™è¯´æ˜æœ€åä¸€æ­¥æ‰§è¡Œçš„æ˜¯ $1\to2$
	- ä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œä¸€ä¸ªè¿˜å‰©ä¸€æ¬¡ï¼Œä¸€ä¸ªç¬¬ä¸€æ¬¡æ‰§è¡Œï¼ˆæ‹¿çš„ sum=0ï¼‰
	- ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ‰§è¡Œçš„æ‰§è¡Œä¹‹å sum ä¸º 1ï¼Œè¿˜å‰©ä¸€æ¬¡çš„æ‹¿åˆ° 1
	- ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„å¿«é€Ÿæ‰§è¡Œå®Œæˆï¼Œè¿˜å‰©ä¸€æ¬¡çš„æ‰§è¡Œä¸€æ¬¡å¾—åˆ° 2

- **ç¼–è¯‘å™¨çš„ä¼˜åŒ–**å¯èƒ½å¸¦æ¥ä¸å¯é¢„æµ‹çš„ç»“æœ
	- `while (!flag);` åœ¨ä¼˜åŒ–ä¹‹åå¹¶ä¸ä¼šè¿›è¡Œåå¤è¯»å–ï¼Œè€Œæ˜¯ä¼šç›´æ¥æ”¹ä¸ºæ­»å¾ªç¯ï¼Œéœ€è¦æ·»åŠ  `volatile` ç»„ç»‡ä¼˜åŒ–

- **å…¨å±€æŒ‡ä»¤æ‰§è¡Œé¡ºåº**çš„å‡è®¾
	- å¤„ç†å™¨ä¹Ÿæ˜¯**ç¼–è¯‘å™¨**ï¼Œä¼šå¯¹æ‰§è¡Œ**ä¼˜åŒ–**ï¼Œåªæ˜¯ä½¿å¾—æŒ‡ä»¤ **"çœ‹èµ·æ¥"** é¡ºåºå®Œæˆï¼ˆå¯èƒ½æ˜¯é’ˆå¯¹è‡ªå·±çš„è§†è§’ï¼‰
	- æ¯”å¦‚å¯ä»¥åŒæ—¶æ‰§è¡Œä¸¤æ¡ä¸æƒ³å…³çš„æŒ‡ä»¤
	- å®é™…çš„å…±äº«å†…å­˜æ¨¡å‹ï¼šä¸åŒå¤„ç†å™¨å¯èƒ½çœ‹åˆ°**ä¸åŒçš„å…±äº«å†…å­˜**
	-  ![image.png|400](https://thdlrt.oss-cn-beijing.aliyuncs.com/20240322120710.png)
```python
def T1():
    heap.x = 1
    sys_sched()
    y_ = heap.y
    sys_sched()
    sys_write(f'{y_}')

def T2():
    heap.y = 1
    sys_sched()
    x_ = heap.x
    sys_sched()
    sys_write(f'{x_}')

def main():
    heap.x, heap.y = 0, 0
    sys_spawn(T1)
    sys_spawn(T2)
```
## å¹¶å‘æ§åˆ¶
### äº’æ–¥
- äº’æ–¥ï¼ˆäº’ç›¸æ’æ–¥ï¼‰ï¼šé˜»æ­¢å¹¶å‘
#### Peterson ç®—æ³• (ç”¨äºä¸¤ä¸ªçº¿ç¨‹)
- æ¯ä¸ªäººæœ‰ä¸€ä¸ªå˜é‡ï¼ˆæ——å­ï¼‰è¡¨ç¤ºè‡ªå·±æ˜¯å¦è¦ä½¿ç”¨ä¸´ç•ŒåŒºèµ„æº
- å¦‚æœè¦ä½¿ç”¨ä¸´ç•ŒåŒºèµ„æºï¼š
	- ä¸¾èµ·**è‡ªå·±çš„æ——å­**ï¼ˆå…ˆï¼‰
	- æŠŠå†™æœ‰**å¯¹æ–¹åå­—**çš„å­—æ¡è´´åœ¨ä¸´ç•ŒåŒºä¸Šï¼ˆåï¼‰
- è¿›å…¥è§‚å¯Ÿè€…æ¨¡å¼ï¼š
	- å¦‚æœ**å¯¹æ–¹æ²¡æœ‰ä¸¾èµ·**æ——å­æˆ–è€…**å­—æ¡ä¸Šæ˜¯è‡ªå·±çš„åå­—**å°±å¯ä»¥ä½¿ç”¨ä¸´ç•ŒåŒºèµ„æºï¼ˆæ‰‹å¿«çš„å…ˆè¿›å…¥ï¼‰
- é‡Šæ”¾ï¼šæ”¾ä¸‹æ——å­
```python
def T1():
    while True:
        heap.x = 'ğŸ´'
        sys_sched()
        heap.turn = 'â·'
        sys_sched()
        while True:
            t = heap.turn
            sys_sched()
            y = heap.y != ''
            sys_sched()
            if not y or t == 'â¶':
                break
        sys_sched()
        heap.cs += 'â¶'
        sys_sched()
        heap.cs = heap.cs.replace('â¶', '')
        sys_sched()
        heap.x = ''
        sys_sched()
 
def T2():
    while True:
        heap.y = 'ğŸ'
        sys_sched()
        heap.turn = 'â¶'
        sys_sched()
        while True:
            t = heap.turn
            sys_sched()
            x = heap.x
            sys_sched()
            if not x or t == 'â·':
                break
            sys_sched()
        sys_sched()
        heap.cs += 'â·'
        sys_sched()
        heap.cs = heap.cs.replace('â·', '')
        sys_sched()
        heap.y = ''
        sys_sched()

def main():
    heap.x = ''
    heap.y = ''
    heap.turn = ''
    heap.cs = ''
    sys_spawn(T1)
    sys_spawn(T2)

```
#### å¤šå¤„ç†å™¨ä¸Šçš„äº’æ–¥
- 
### åŒæ­¥